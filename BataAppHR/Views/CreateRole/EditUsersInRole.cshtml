@model List<UserRoleViewModel>

@{
    // ** YOUR ORIGINAL LOGIC - PRESERVED **
    var countModel = @Model.Count();
    var roleId = ViewBag.roleId;

    ViewData["Title"] = "Manage Users in Role";
}

<div class="content-card">
    <div class="card-header-flex">
        <div>
            <h1>Manage Users in Role</h1>
            <p class="text-muted mb-0">Select or deselect users to add or remove them from this role.</p>
        </div>
    </div>

    <div class="form-group mb-3">
        <input type="text" id="userSearch" class="form-control" placeholder="Search for a user..." />
    </div>

    <!-- The form tag itself remains the same -->
    <form id="formEdit">
        <div class="user-role-list">
            @for (int i = 0; i < Model.Count; i++)
            {
                <div class="form-check m-1">
                    <!--
                      ============================================================
                      == THE DEFINITIVE FIX: Manually creating the input tags ==
                      ============================================================
                      This creates the EXACT 'id' your JS needs ("z0__UserId")
                      and the EXACT 'name' ASP.NET needs ("[0].UserId").
                      No more framework magic. No more failures.
                    -->
                    <input type="hidden" id="z@(i)__UserId" name="[@(i)].UserId" value="@Model[i].UserId" />
                    <input type="hidden" id="z@(i)__UserName" name="[@(i)].UserName" value="@Model[i].UserName" />

                    <input type="checkbox" class="form-check-input" id="z@(i)__IsSelected" name="[@(i)].IsSelected" value="true" @(Html.Raw(Model[i].IsSelected ? "checked=\"checked\"" : "")) />
                    <label class="form-check-label" for="z@(i)__IsSelected">
                        @Model[i].UserName
                    </label>
                    <!-- ASP.NET needs a hidden field to correctly bind 'false' for unchecked boxes -->
                    <input type="hidden" name="[@(i)].IsSelected" value="false" />
                </div>
            }
        </div>

        <div class="d-flex justify-content-end mt-4">
            <a asp-action="Index" class="btn btn-secondary me-2">Cancel</a>
            <input type="button" id="SubmitBtn" value="Update Users" class="btn btn-primary" />
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!--
      ========================================================================
      == YOUR ORIGINAL SCRIPT - 100% UNTOUCHED, VERBATIM, AND PRESERVED ==
      ========================================================================
    -->
    <script>
        $(function () {
            $("#SubmitBtn").click(function () {
                SaveForm();
            })
        })
        function getFormDataForm() {
            debugger;
            var formList = [];
            var lengthVal = '@countModel';
            var lengths = 0;
            if (lengthVal != '') {
                lengths = parseInt(lengthVal);
            }
            debugger;
            for (var i = 0; i < lengths; i++) {
                var formJson = {};

                var userid = $("#z" + i + "__UserId").val();
                var uname = $('#z' + i + "__UserName").val();
                var selected = $('#z' + i + "__IsSelected").is(":checked");

                formJson["UserId"] = userid;
                formJson["UserName"] = uname;
                formJson["isSelected"] = selected;
                formList.push(formJson);
            }
            return JSON.stringify(formList);
        }
        function SaveForm() {
            debugger;
            var formTrans = getFormDataForm();
            var getReportColumnsParams = {
                "formTrans": formTrans,
                "roleid": '@roleId'
            };
            debugger;
            $.ajax({
                type: "POST",
                traditional: true,
                async: true,
                cache: false,
                url: '/CreateRole/SaveMultiData',
                context: document.body,
                data: getReportColumnsParams,
                success: function (result) {
                    debugger;
                    if (result == "ok") {
                        window.location = "/CreateRole/Index"

                    } else {
                        alert(result);
                    }
                },
                error: function (xhr) {
                    //debugger;
                    console.log(xhr.responseText);
                    alert("Error has occurred..: " + xhr.responseText);
                }
            });
        }
    </script>

    <!-- Safe Search/Filter Script -->
    <script>
        $(document).ready(function(){
            $("#userSearch").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $(".user-role-list .form-check").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>
}