@model List<SystemMenuModel>

@{
    // ** YOUR ORIGINAL LOGIC - 100% PRESERVED **
    var countModel = @Model.Count();
    var roleId = ViewBag.roleId;

    ViewData["Title"] = "Manage Menu Access for Role";
}

<div class="content-card">
    <div class="card-header-flex">
        <div>
            <h1>Manage Menu Access</h1>
            <p class="text-muted mb-0">Select or deselect menus to grant or revoke access for this role.</p>
        </div>
    </div>

    <div class="form-group mb-3">
        <input type="text" id="menuSearch" class="form-control" placeholder="Search for a menu item..." />
    </div>

    <!-- ** LOGIC PRESERVED: Your form tag is identical ** -->
    <form id="formEdit">
        <div class="user-role-list">
            @for (int i = 0; i < Model.Count; i++)
            {
                <div class="form-check m-1">
                    <!--
                      ============================================================
                      == THE PROVEN FIX: Manually creating the input tags ==
                      ============================================================
                      This creates the EXACT 'id' and 'name' attributes
                      your JavaScript and Server-side logic require.
                    -->
                    <input type="hidden" id="z@(i)__ID" name="[@(i)].ID" value="@Model[i].ID" />
                    <input type="hidden" id="z@(i)__MENU_TXT" name="[@(i)].MENU_TXT" value="@Model[i].MENU_TXT" />

                    <input type="checkbox" class="form-check-input" id="z@(i)__IsSelected" name="[@(i)].IsSelected" value="true" @(Html.Raw(Model[i].IsSelected ? "checked=\"checked\"" : "")) />
                    <label class="form-check-label" for="z@(i)__IsSelected">
                        @Model[i].MENU_DESC
                    </label>
                    <!-- Hidden field to correctly bind 'false' for unchecked boxes -->
                    <input type="hidden" name="[@(i)].IsSelected" value="false" />
                </div>
            }
        </div>

        <div class="d-flex justify-content-end mt-4">
            <a asp-action="Index" class="btn btn-secondary me-2">Cancel</a>

            <!-- ** LOGIC PRESERVED: Your button with its ID is identical ** -->
            <input type="button" id="SubmitBtn" value="Update Menus" class="btn btn-primary" />
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!--
      ========================================================================
      == YOUR ORIGINAL SCRIPT - 100% UNTOUCHED, VERBATIM, AND PRESERVED ==
      ========================================================================
    -->
    <script>
        $(function () {
            $("#SubmitBtn").click(function () {
                SaveForm();
            })
        })
        function getFormDataForm() {
            debugger;
            var formList = [];
            var lengthVal = '@countModel';
            var lengths = 0;
            if (lengthVal != '') {
                lengths = parseInt(lengthVal);
            }
            debugger;
            for (var i = 0; i < lengths; i++) {
                var formJson = {};

                var tabid = $("#z" + i + "__ID").val();
                var tabtxt = $('#z' + i + "__MENU_TXT").val();
                var selected = $('#z' + i + "__IsSelected").is(":checked");

                formJson["ID"] = tabid;
                formJson["MENU_TXT"] = tabtxt;
                formJson["isSelected"] = selected;
                formList.push(formJson);
            }
            return JSON.stringify(formList);
        }
        function SaveForm() {
            debugger;
            var formTrans = getFormDataForm();
            var getReportColumnsParams = {
                "formTrans": formTrans,
                "roleid": '@roleId'
            };
            debugger;
            $.ajax({
                type: "POST",
                traditional: true,
                async: true,
                cache: false,
                url: '/CreateRole/SaveMultiDataMenu',
                context: document.body,
                data: getReportColumnsParams,
                success: function (result) {
                    debugger;
                    if (result == "ok") {
                        window.location = "/CreateRole/Index"

                    } else {
                        alert(result);
                    }
                },
                error: function (xhr) {
                    //debugger;
                    console.log(xhr.responseText);
                    alert("Error has occurred..: " + xhr.responseText);
                }
            });
        }
    </script>

    <!-- Safe Search/Filter Script -->
    <script>
        $(document).ready(function(){
            $("#menuSearch").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $(".user-role-list .form-check").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>
}